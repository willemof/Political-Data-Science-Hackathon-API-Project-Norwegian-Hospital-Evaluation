---
title: "Anton Notes ISSSV1337"
author: "Anton Kristian Bugge"
date: "`r Sys.Date()`"
output: pdf_document
---

## Cheat sheet
command + option + i for a chunk!

`{r, echo = FALSE}` to only show output, and not the code itself (e.g for a plot)

`{r, echo = TRUE}` to show code

`{r, eval = FALSE}` to not run a chunk

`{r, error = FALSE}` to hide error messages

`{r, message = FALSE}` prevents messages that are generated by code from appearing in the finished file

`{r, warning = FALSE}` prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.

`{r, fig.cap = "..."}` adds a caption to graphical results.

## Library
```{r}
library(httr)
library(tinytex)
library(tidyverse)
library(janitor)
library(kableExtra)
library(rjstat)
```


## To knit to pdf
```{r, message = FALSE, warning = FALSE, echo = TRUE}
# install.packages("tinytex")
library(tinytex)
# install_tinytex()
```

## Basic piping and *tidyverse*. `select`, `filter`, `rename`

```{r, warning = FALSE, message = FALSE}
costofliving <- read_csv(file = "costofliving.csv")

costofliving <- costofliving %>%
  clean_names()
```

```{r, include = TRUE, echo = TRUE}

glimpse(costofliving)

costofliving <- costofliving %>%
  select(city, cost_of_living_index, groceries_index) %>%
  filter(cost_of_living_index > 100)
```

```{r, include = TRUE, echo = TRUE}
costofliving %>%
  filter(city == 'Oslo, Norway')
```

```{r, include = TRUE, echo = TRUE}
costofliving %>%
  filter(city %in% c('Oslo, Norway',
                   'Stavanger, Norway'))
```

```{r, include = TRUE, echo = TRUE}
costofliving <- costofliving %>%
  rename(cofl = cost_of_living_index)
```

```{r, warning = FALSE}
costofliving <- costofliving %>%
  separate(city, into = c("City", "Country", sep = ", "))
```

```{r}
# costofliving %>%
 #  mutate(share = restaurant_price_index/local_purchasing_power_index)
```

##`ifelse`
```{r}
costofliving <- costofliving %>%
    mutate(norway = ifelse(Country == "Norway", 1, 0))
    # mutate(norway_sweden = ifelse(Country %in% c("Norway", "Sweden"), 1, 0))
```

##`summarise` and `group_by`

 - `summarise` gives summary statistics
 
 - `group_by` gives the summary statistics per some variable(s)
 
```{r}
costofliving %>%
  summarise(cofi_sum = sum(cofl, na.rm = TRUE))
```

```{r}
costofliving %>%
  group_by(Country) %>%
  summarise(cofi_sum = sum (cofl, na.rm = TRUE))
```

```{r}
costofliving %>%
  group_by(Country) %>%
  summarise(cofi_avg = mean (cofl, na.rm = TRUE)) %>%
  ungroup()
```

```{r}
costofliving %>%
  group_by(Country) %>%
  count() %>%
  arrange(desc(n)) %>%
  ungroup() # for å forhindre at gruppene forblir når man bruker group_by
```
## For nice tables

```{r, message = FALSE}
small_table <- costofliving %>%
  select(Country, City, cofl) %>%
  filter(City %in% c("Oslo", "Stavanger", "Bergen"))
```
## Some case-specific info

 - Helsedirektoratet does not have an R package for their API (yet), so we got to use old-fashioned `httr`. [This page](https://www.helsedirektoratet.no/om-oss/apne-data-api/hvordan-finne-frem-i-innholdet) gives some indication of the arguments for the endpoint. 
 - You also need to register, follow [this link](https://www.helsedirektoratet.no/om-oss/apne-data-api/fa-tilgang-til-helsedirektoratets-api-tjeneste-hapi) to do that. Since the API requires authorization, you have to add the "headers" argument as well. 

```{r, eval=FALSE}

GET("https://api-qa.helsedirektoratet.no/helserefusjon/v1/bandasjister", 
    # example of endpoint
    add_headers("Ocp-Apim-Subscription-Key" = "5305a0f74cbb4eb5a0d03f4549124482")) %>% 
  # how to authorize in the httr package
  content(as = "text") %>% # extratcing the data
  jsonlite::fromJSON(flatten = TRUE) # parsing to dataframe

```

```{r, message = FALSE}

small_table %>%
  kable() %>%
  kable_styling()

```

# Helsedirektoratet API

```{r}
# https://utvikler.helsedirektoratet.no/api-details#api=5e2175179724dab67f9cbfa4&operation=5e21751e8dfb3ae4a5fd9657
# https://api.helsedirektoratet.no/innhold/nki/kvalitetsindikatorer

getwd()

helsedir_nki <- GET("https://api.helsedirektoratet.no/innhold/nki/kvalitetsindikatorer")

status_code(helsedir_nki)

headers(helsedir_nki)
```

# Alle kvalitetsindikatoter
```{r, eval=FALSE}

helsedir_nki <- GET("https://api.helsedirektoratet.no/innhold/nki/kvalitetsindikatorer/", 
    # example of endpoint
    add_headers("Ocp-Apim-Subscription-Key" = "281a8d6d65e247798f50513cef5ea2e1")) %>% 
  # how to authorize in the httr package
  content(as = "text") %>% # extracting the data
  jsonlite::fromJSON(flatten = TRUE, ) # parsing to dataframe

```

```{r}
utsettelse_plan_op <- GET("https://api.helsedirektoratet.no/innhold/nki/kvalitetsindikatorer/0003-0010-284", 
    # example of endpoint
    add_headers("Ocp-Apim-Subscription-Key" = "281a8d6d65e247798f50513cef5ea2e1")) %>% 
  # how to authorize in the httr package
  content(as = "text") %>% # extracting the data
  jsonlite::fromJSON(flatten = TRUE, ) # parsing to dataframe

test <- as.data.frame(do.call(cbind, utsettelse_plan_op))

#Utsettelse av planlagte operasjoner 0003-0010-284

```
